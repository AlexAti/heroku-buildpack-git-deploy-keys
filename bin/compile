#!/usr/bin/env ruby

require 'fileutils'
require 'pathname'

build_dir    = ARGV[0]
cache_dir    = ARGV[1]
env_dir      = ARGV[2]

def putter(arg)
  puts "############################################"
  puts arg
end

puts "############################################"
puts "############################################"
puts "          GIT DELOY KEY BUILDPACK           "
puts "############################################"
puts "############################################"

key_file_path = File.join env_dir, 'GITHUB_DEPLOY_KEY'

putter key_file_path

ssh_key = File.open(key_file_path, &:read) if File.exist? key_file_path

putter ssh_key

if ssh_key.nil?
  puts "       !!!! GITHUB_DEDLOY_KEY not set"
  puts "       !!!!   Try `heroku config:add GITHUB_DEPLOY_KEY=<my token>`"
  exit 1
end

FileUtils.mkdir_p "#{build_dir}/.profile.d"
File.open "#{build_dir}/.profile.d/ssh.sh", "a" do |f|
  f.puts "mkdir ~/.ssh"

  f.puts "echo 'Host *' >> ~/.ssh/config"
  f.puts "echo '     StrictHostKeyChecking no' >> ~/.ssh/config"
  f.puts "echo 'Host github.com' >> ~/.ssh/config"
  f.puts "echo '     User git' >> ~/.ssh/config"
  f.puts "echo '     IdentityFile ~/.ssh/github_deploy_key' >> ~/.ssh/config"
  f.puts "echo 'IdentityFile ~/.ssh/github_deploy_key' >> ~/.ssh/config"

  f.puts %|echo "#{ssh_key}" > ~/.ssh/github_deploy_key|
end

File.open "#{build_dir}/.profile.d/ssh.sh", "r" do |f|
  puts f.read
end
